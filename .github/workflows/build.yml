name: Build UE5 Project

on:
  # (1) mainブランチにpushされた時に実行する
  #どういうときにGitHubからダウンロードしてくるかトリガーのようなもの？
  # push:
  #  branches: ["main"]
  #上記はpush時にCI働く。これがないとGitHubActionsから手動で行う。

  # (2) GitHubの画面から手動で実行できるようにする
  #セルフホストランナーは "C:\actions-runner\_work" で動く
  workflow_dispatch:

jobs:
  build-windows:
    # あなたのPC（セルフホストランナー）で実行する
    runs-on: self-hosted

    steps:
      # ステップ1a: コード本体だけをチェックアウト (LFSはまだ)
      - name: Checkout repository (code only)
        uses: actions/checkout@v4
        with:
          # lfs: true  <-- ★ lfs: true を削除 ★
          token: ${{ secrets.MY_PAT }} # PATはここでも使う

      # ステップ1b: LFSファイルを明示的にダウンロード ★ここを追加★
      - name: Pull LFS files
        shell: cmd # cmdを使うように指定
        run: git lfs pull
        env:
          # git lfs pull コマンドに PAT を渡す (認証のため)
          GITHUB_TOKEN: ${{ secrets.MY_PAT }}

      # ステップ2: UATコマンドでゲームをパッケージ化する
      - name: Build and Package
        shell: powershell # PowerShellで実行
        run: |
          Write-Host "Starting UE5 Build..."

          # --- ★ あなたのPC環境に合わせてパスを編集してください ★ ---

          # 1. UE5.4のインストールパス
          $UE_ROOT = "C:\Program Files\Epic Games\UE_5.4"

          # 2. プロジェクトの.uprojectファイル
          # ($env:GITHUB_WORKSPACE は、CIがコードをダウンロードした場所を指します)
          # $env:GITHUB_WORKSPACE=C:\actions-runner\_work\ReibaFight\ReibaiFight
          $PROJECT_PATH = "$env:GITHUB_WORKSPACE\ReibaiFight.uproject" 

          # 3. ビルド成果物の出力先
          $ARCHIVE_DIR = "$env:GITHUB_WORKSPACE\Builds\Windows"

          # --- ここから下は編集不要 ---

          & "$UE_ROOT\Engine\Build\BatchFiles\RunUAT.bat" BuildCookRun -project=$PROJECT_PATH -archive -archivedirectory=$ARCHIVE_DIR -platform=Win64 -clientconfig=Shipping -cook -stage -pak -prereqs

          Write-Host "Build Finished."

      # ステップ3: (オプション) 完成したビルドをzipで保存する
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Build
          path: Builds\Windows # ステップ2の出力先と同じ
